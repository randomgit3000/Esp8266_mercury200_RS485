# Esp8266 BLYNK Меркурий 200 RS485


*Код рабочий, но не дописан.*

Сетевой адрес электросчетчика Меркурий 200 - 6 крайних цифр серийного номера. Он же служит паролем для доступа.  
В скетче адрес нужно вносить самостоятельно, вместе с командой (предварительно переведя его в нужный формат).  
Если адрес совпадает с серийником, то первый байт будет 00, если адрес шифровался(см. ниже) то может иметь длину 4 байта включая первый в запросе.
Далее идет команда из одного байта. Последними в запросе идут CRC которые рассчитываются автоматически на этапе отсылки иcходя из содержания "адрес + команда".

 Типовая схема подключения компонентов:

![](/images/Schematic_Mercury_200_RS485_ESP8266.png)

## Проверки  
Так как в случае неверной команды или адреса счетчик не дает никакого ответа, проверить работоспособность сборки довольно сложно. Для проверки можно воспользоваться любым сниффером COM порта + недорогим USB RS485 адаптером.  
Для этого нужно подключить выходы с RS485 на плате к аналогичным выходам на USB RS485 (A-A, B-B).

![](/images/Schematic_RS485_ESP8266_USB.JPG)

В скетче для ESP 8266 необходимо изменить переменную "test_mode" с 0 на 1 (int test_mode = 1) и прошить. В этом режиме плата будет по очереди посылать команду из byte test_cmd[], и ожидать по 5 секунд любую входящую передачу.  
Сниффером на порту USB RS485 адаптера можно видеть какие запросы посылает ESP, а в мониторе порта куда подключена ESP (например в среде разработки) можно видеть что получает ESP (например во время запроса из Конфигуратора Меркурия в порт USB RS485 адаптера).  

![](/images/ESP_test_out.JPG)  

Во время запроса с Конфигуратора, команды показанные в сниффере должны совпадать с выводимыми ESP в её монитор порта.

![](/images/ESP_test_in.JPG)  

Если по каким либо причинам счетчик все равно не отвечает на запросы по адресу из серийного номера на корпусе - вероятно ранее его адрес был изменен кем то еще.
Можно попытаться восстановить адрес специальным инструментом в Конфигураторе Меркурия.  
На странице "Параметры связи"  нужно нажать комбинацию Ctr+Alt+N.  

![](/images/konfigurator_ctrl_alt_n.JPG)
![](/images/konfigurator_ctrl_alt_n2.JPG)

Для проверки работоспособности самого счетчика или обнаружения дополнительных команд можно также пользоваться Конфигуратором + сниффер + USB RS485 подключенным напрямую к счетчику в такой же полярности AB как и RS485+ESP на cхеме выше.   
Пример запроса и ответа от счетчика.

![](/images/konfigurator_energy.JPG)  

  Желтым выделены запросы Конфигуратора, белым - ответы счетчика:  

![](/images/serial_energy.JPG)

Другие команды можно найти в документации о протоколе обмена на сайте Инкотекс.  

### В скетче также предусмотрены:
- Прошивка по воздуху.
- Работа с датчиком температуры DS18b20.
- Отправка данных в приложение BLYNK.

Для подключения к Wifi нужно переименовать credentials_х.h в credentials.h и вписать свои данные.